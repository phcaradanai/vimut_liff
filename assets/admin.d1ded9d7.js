import{_ as k,o as d,c as m,b as c,t as g,r as j,d as f,w as T,e as h,f as x,F as b,g as w,h as M,v as O,i as q,j as V,a as _,k as A,m as P,n as B,l as L,p as z,q as N,s as S,x as J,y as E}from"./index.4812cd53.js";const W={props:{iconTrue:String,iconFalse:String,trueValue:String,falseValue:String,modelValue:[Boolean,String,Number]},emits:["update:modelValue"],computed:{checked(){var t;return this.modelValue===((t=this.trueValue)!=null?t:!0)}},methods:{toggleChecked(t){var e,i;this.$emit("update:modelValue",this.checked?(e=this.falseValue)!=null?e:!1:(i=this.trueValue)!=null?i:!0)}}},F={class:"button flex justify-center items-center"},R={class:"m-icon w-4 h-4 text-[16px] justify-center items-center"};function U(t,e,i,s,n,o){return d(),m("div",{class:"ui-switch h-8 flex items-center",onClick:e[0]||(e[0]=(...l)=>o.toggleChecked&&o.toggleChecked(...l))},[c("div",F,[c("div",R,g(o.checked?i.iconTrue:i.iconFalse),1)])])}const D=k(W,[["render",U]]),G={props:{item:{type:Object,required:!0},expanded:{type:Object,default(){return{}}}},emits:["toggle","item-click","item-toggle"],methods:{doClick(t){var e;t.preventDefault(),(e=this.item.items)!=null&&e.length?this.$emit("toggle",this.item.id):typeof this.item.click=="function"?this.item.click(this.item):typeof this.item.toggle=="function"&&this.item.toggle(),this.$emit("item-click",this.item)}}},K={class:"ui-list-item flex flex-col :not:last-of-type:border-b-[1px] :not:last-of-type:border-b-light-900"},Q={class:"flex-shrink-0 flex items-center"},X={class:"m-icon"},H={key:0,class:"h-6 leading-6 font-bold text-sm"},Y={key:1,class:"flex-grow h-10 leading-10"},Z={class:"flex"},ee={key:0,class:"flex-shrink-0"},te={class:"m-icon"};function ie(t,e,i,s,n,o){var r;const l=j("router-link"),a=I;return d(),m("li",K,[f(l,{class:"flex px-4 gap-4",to:i.item.to||"","exact-active-class":i.item.to?"exact-active":"",onClick:o.doClick},{default:T(()=>{var u;return[h(t.$slots,"default",{},()=>{var p;return[i.item.icon?h(t.$slots,"item-icon",{key:0,item:i.item},()=>[c("div",Q,[c("div",X,g(i.item.icon),1)])]):x("",!0),i.item.text||i.item.header?h(t.$slots,"item-content",{key:1},()=>[i.item.header?(d(),m("div",H,g(i.item.text),1)):i.item.text?(d(),m("div",Y,g(i.item.text),1)):x("",!0)]):x("",!0),(p=i.item.actions)!=null&&p.length?h(t.$slots,"item-actions",{key:2},()=>[c("div",Z,[(d(!0),m(b,null,w(i.item.actions,C=>(d(),m("div",{key:C.id},g(C.id),1))),128))])]):x("",!0)]}),(u=i.item.items)!=null&&u.length?(d(),m("button",ee,[c("span",te,g(i.expanded[i.item.id]?"expand_more":"chevron_right"),1)])):x("",!0)]}),_:3},8,["to","exact-active-class","onClick"]),(r=i.item.items)!=null&&r.length?M((d(),q(a,{key:0,class:"border-1 border-gray-500",items:i.item.items,onItemClick:e[0]||(e[0]=u=>t.$emit("item-click",u)),onItemToggle:e[1]||(e[1]=u=>t.$emit("item-toggle",u))},null,8,["items"])),[[O,i.expanded[i.item.id]]]):x("",!0)])}const se=k(G,[["render",ie]]),oe={props:{items:{type:Array,default(){return[]},required:!0},expanded:{type:Object,default(){return{}}}},emits:["toggle","item-click","item-toggle"],methods:{itemToggle(t){this.$emit("item-toggle",t)}}},ne={class:"ui-list py-2"},le=c("hr",null,null,-1);function ae(t,e,i,s,n,o){const l=se;return d(),m("ul",ne,[(d(!0),m(b,null,w(i.items,a=>(d(),m(b,{key:a.id},[a.type==="sep"?h(t.$slots,"sep",{key:0,item:a},()=>[le]):h(t.$slots,"list-item",{key:1,item:a},()=>[f(l,{item:a,expanded:i.expanded,onToggle:e[0]||(e[0]=r=>t.$emit("toggle",r)),onItemClick:e[1]||(e[1]=r=>t.$emit("item-click",r)),onItemToggle:o.itemToggle},null,8,["item","expanded","onItemToggle"])])],64))),128))])}const I=k(oe,[["render",ae]]);const re={props:{modelValue:[String,Number],items:{type:Array,default(){return[]}},pk:{type:String,default:"id"}},emits:["update:modelValue"]},ce=["value","selected"];function de(t,e,i,s,n,o){return d(),m("select",{class:"ui-select h-8 rounded-md px-2",onChange:e[0]||(e[0]=l=>t.$emit("update:modelValue",l.target.value))},[(d(!0),m(b,null,w(i.items,l=>(d(),m("option",{key:l[i.pk],value:l[i.pk],selected:i.modelValue===l[i.pk]},[h(t.$slots,"item",{item:l},()=>[V(g(l.text),1)])],8,ce))),128))],32)}const me=k(re,[["render",de]]),ue=[{id:"home",to:"/xt",icon:"home",text:"menu.dashboard"},{id:"reports",icon:"summarize",text:"menu.report",items:[{id:"report-status",icon:"summarize",text:"menu.reportStatus",to:"/xt/reports/status"},{id:"report-noti",icon:"summarize",text:"menu.reportNoti",to:"/xt/reports/noti"},{id:"report-summary",icon:"summarize",text:"menu.reportSummary",to:"/xt/reports/summary"},{id:"report-monthly",icon:"summarize",text:"menu.reportMonthly",to:"/xt/reports/monthly"},{id:"report-covid",icon:"summarize",text:"menu.reportCovid",to:"/xt/reports/covid"}]},{id:"manage",icon:"manage_accounts",text:"menu.manage",items:[{id:"xentemp",icon:"face",text:"menu.manageXentemp",to:"/xt/manage/xentemp"},{id:"receptors",icon:"face",text:"menu.manageReceptor",to:"/xt/manage/receptors"},{id:"temp-profile",icon:"face",text:"menu.manageTempProfile",to:"/xt/manage/tempProfiles"},{id:"noti-profile",icon:"face",text:"menu.manageNotiProfile",to:"/xt/manage/notiProfiles"},{id:"operator",icon:"face",text:"menu.manageOperator",to:"/xt/manage/operators"}]},{id:"admin",icon:"admin_panel_settings",text:"menu.admin",items:[{id:"projects",icon:"domain",text:"menu.adminProject",to:"/xt/admin/projects"},{id:"staffs",icon:"manage_accounts",text:"menu.adminStaff",to:"/xt/admin/users"},{id:"roles",icon:"security",text:"menu.adminRole",to:"/xt/admin/roles"},{id:"audits",icon:"policy",text:"menu.adminAudit",to:"/xt/admin/audits"}]},{id:"setup",icon:"settings",text:"menu.setup",items:[{id:"modules",icon:"grade",text:"menu.setupModule",to:"/xt/setup/modules"}]}];const pe={data(){const t=[{id:"",text:"Admin"},{id:"profile",text:"Profile"}];return{appStore:_(),profileId:"",profileList:t,langList:[{id:"th",text:"\u0E44\u0E17\u0E22"},{id:"en",text:"Eng"}],expanded:{},menus:ue}},computed:{...A(_,["showNav"]),...P(_,["theme","lang"]),menusWithAcl(){return this.filteredMenu(this.menus)}},watch:{lang(t){this.$i18n.locale=t}},methods:{toggleNav(){this.appStore.toggleNav()},onProfileSelect(t){let e=t.target.value;setTimeout(()=>{this.profileId="",window.getComputedStyle(this.$refs.menuBg).display!=="none"&&this.appStore.toggleNav()},0),e==="profile"&&this.$router.push("/profile")},toggleMenu(t){this.expanded[t]=this.expanded[t]?0:1},itemClick(t){window.getComputedStyle(this.$refs.menuBg).display!=="none"&&this.appStore.toggleNav()},filteredMenu(t){let e=[];for(let i of t)if(!(i.acl&&!this.$acl.can(i.acl)))if(i.items){let s=this.filteredMenu(i.items);if(!s.length)continue;e.push({...i,text:this.$t(i.text),items:s})}else e.push({...i,text:this.$t(i.text)});return e}}},fe={class:"panel"},ge={class:"logo"},he=["src"],_e={class:"top py-2"},xe={class:"flex gap-3 items-center h-8"},ye=c("div",{class:"h-8 w-8 rounded-full bg-gray-400 flex-shrink-0"},null,-1),ke={class:"flex-grow flex items-center"},ve={class:"content"},be={class:"bottom flex gap-x-6"},Se={class:"flex-shrink-0"},we={class:"flex-shrink-0 flex"},Ce={class:"flex-grow flex"};function Ne(t,e,i,s,n,o){const l=me,a=I,r=D,u=L;return d(),m("div",{class:B(["app-nav",{show:t.showNav}])},[c("div",{ref:"menuBg",class:"bg",onClick:e[0]||(e[0]=(...p)=>o.toggleNav&&o.toggleNav(...p))},null,512),c("div",fe,[c("div",ge,[c("img",{src:`/images/xenex_${t.theme}.png`,class:"h-6"},null,8,he)]),c("div",_e,[c("div",xe,[ye,c("div",ke,[f(l,{class:"flex-grow",modelValue:n.profileId,"onUpdate:modelValue":e[1]||(e[1]=p=>n.profileId=p),items:n.profileList,onChange:o.onProfileSelect},null,8,["modelValue","items","onChange"])])])]),c("div",ve,[f(a,{items:o.menusWithAcl,expanded:n.expanded,onToggle:o.toggleMenu,onItemClick:o.itemClick},null,8,["items","expanded","onToggle","onItemClick"])]),c("div",be,[c("div",Se,[f(r,{modelValue:t.theme,"onUpdate:modelValue":e[2]||(e[2]=p=>t.theme=p),"true-value":"light","false-value":"dark","icon-true":"light_mode","icon-false":"dark_mode"},null,8,["modelValue"])]),c("div",we,[f(l,{class:"flex-grow",modelValue:t.lang,"onUpdate:modelValue":e[3]||(e[3]=p=>t.lang=p),items:n.langList},null,8,["modelValue","items"])]),c("div",Ce,[f(u,{class:"flex-grow"},{default:T(()=>[V(g(t.$t("auth.signout")),1)]),_:1})])])])],2)}const $e=k(pe,[["render",Ne]]),je=new window.SharedWorker("/js/mqtt-worker.js"),y=je.port;y.start();const v={};y.addEventListener("message",async t=>{var i,s;let e=t.data;if(e.type==="connect")console.log("mqtt-worker",e.id,"connected");else if(e.type==="message"){let n=e.topic,o=e.payload,l=(i=v[e.id])==null?void 0:i.topics;if(!((s=l==null?void 0:l[n])!=null&&s.length)){console.log("mqtt",e.id,"no subscribe for topic",n);return}let a=o;try{let r=await Ie(o,"utf-8");a=JSON.parse(r)}catch(r){console.log("mqtt",e.id,"payload not a json",o.toString("utf-8")),console.log(r.message)}for(let r of l[n])typeof r=="function"&&r(n,a)}else e.type==="disconnect"?console.log("mqtt",e.id,"disconnected"):e.type==="reconnect"?console.log("mqtt",e.id,"reconnecting"):console.log("wsMqtt: unknown data",e)});function Te(t,e){return v[t]||(v[t]=new Ve(t,e)),v[t]}class Ve{constructor(e,i){this.id=e,this.topics={};let s=JSON.parse(JSON.stringify({type:"connect",id:e,...i}));y.postMessage(s)}publish(e,i){let s=JSON.parse(JSON.stringify({id:this.id,type:"publish",topic:e,payload:i}));y.postMessage(s)}subscribe(e,i){this.topics[e]?this.topics[e].find(o=>o===i)||this.topics[e].push(i):this.topics[e]=[i];let s=JSON.parse(JSON.stringify({id:this.id,type:"subscribe",topic:e}));y.postMessage(s)}unsubscribe(e,i){var s,n;if((s=this.topics[e])!=null&&s.length){let o=this.topics[e].findIndex(l=>l===i);o>=0&&this.topics[e].splice(o,1)}if(!((n=this.topics[e])!=null&&n.length)){let o=JSON.parse(JSON.stringify({id:this.id,type:"unsubscribe",topic:e}));y.postMessage(o)}}}function Ie(t,e){return new Promise(i=>{let s=new Blob([t],{type:"application/octet-stream"}),n=new FileReader;n.onload=o=>{i(o.target.result)},e?n.readAsText(s,e):n.readAsText(s)})}const Me=z("master",{state(){return{projects:[],receptors:[],xentemp:[],notiProfiles:[],tempProfiles:[],operators:[],roles:[],users:[]}},getters:{receptorLookup(t){return N(t.receptors,"id")},xentempLookup(t){return N(t.xentemp,"id")}},actions:{async fetchMaster(){try{let{data:t}=await S({methods:"GET",url:"/api/master"});for(let e of Object.keys(t.data))!this[e]||(this[e]=J(t.data[e]))}catch(t){console.log("error",t.message)}},async updateMaster(t){await S({method:"POST",url:"/api/master",data:t})},subscribeChange(){var i;const t=_().profile;if(!((i=t.project.config)!=null&&i.mqtt)){console.log("NO MQTT config");return}Te("default",t.project.config.mqtt).subscribe("ws/0000/a",this.onChange)},onChange(t,e){var o,l;const s=_().profile.user;let n=e;for(let a of Object.keys(n))if(!!this[a]){if((o=n[a].upd)!=null&&o.length)for(const r of n[a].upd){if(!(a==="project"&&(s.config.isAdmin===1||r.id===s.projectId))){if(r.projectId&&s.projectId&&r.projectId!==s.projectId)continue}let u=this[a].findIndex(p=>p.id===r.id);u>=0?this[a].splice(u,1,{...this[a][u],...r}):this[a].push(r)}if((l=n[a].del)!=null&&l.length)for(const r of n[a].del){let u=this[a].findIndex(p=>p.id===r);this[a][u].isActive="N"}}}}});let $;const Oe={async beforeRouteEnter(t,e,i){const s=_(),n=s.token;if(!n)return console.log("TOKEN GONE!!!"),delete S.defaults.headers.common.Authorization,i("/auth");S.defaults.headers.common.Authorization=`Bearer ${n}`;const o=Me();await Promise.all([s.fetchProfile(),o.fetchMaster()]),o.subscribeChange(),clearInterval($),$=setInterval(()=>{s.fetchToken()},3e5),i()},beforeRouteUpdate(t,e){var s;let i=(s=t.matched[t.matched.length-1])==null?void 0:s.components.default;if(i&&i.acl&&!E().can(i.acl))return _().setToken(""),this.$route.replace("/auth/signin")}};function qe(t,e,i,s,n,o){const l=j("router-view"),a=$e;return d(),m(b,null,[f(l),f(a)],64)}const Pe=k(Oe,[["render",qe]]);export{Pe as default};
